step 1
WITH top_countries AS ( 
    SELECT D.country 
    FROM customer A 
    INNER JOIN address B ON A.address_id = B.address_id 
    INNER JOIN city C ON B.city_id = C.city_id 
    INNER JOIN country D ON C.country_id = D.country_id 
    GROUP BY D.country 
    ORDER BY COUNT(A.customer_id) DESC 
    LIMIT 10 
), 
top_cities AS ( 
    SELECT C.city 
    FROM customer A 
    INNER JOIN address B ON A.address_id = B.address_id 
    INNER JOIN city C ON B.city_id = C.city_id 
    INNER JOIN country D ON C.country_id = D.country_id 
    WHERE D.country IN (SELECT country FROM top_countries) 
    GROUP BY D.country, C.city 
    ORDER BY COUNT(A.customer_id) DESC 
    LIMIT 10 
), 
customer_totals AS ( 
    SELECT  
        A.customer_id, 
        A.first_name, 
        A.last_name, 
        D.country, 
        C.city, 
        SUM(pay.amount) AS total_amount_paid 
    FROM customer A 
 
 
 
    INNER JOIN payment pay ON A.customer_id = pay.customer_id 
    INNER JOIN address B ON A.address_id = B.address_id 
    INNER JOIN city C ON B.city_id = C.city_id 
    INNER JOIN country D ON C.country_id = D.country_id 
    WHERE C.city IN (SELECT city FROM top_cities) 
    GROUP BY A.customer_id, A.first_name, A.last_name, D.country, C.city 
    ORDER BY total_amount_paid DESC 
    LIMIT 5 
) 
SELECT AVG(total_amount_paid) AS average_amount_paid 
FROM customer_totals; 
######################## step 2 
WITH customer_totals AS ( 
SELECT  
A.customer_id, 
D.country, 
SUM(pay.amount) AS total_sum 
FROM customer A 
INNER JOIN payment pay ON A.customer_id = pay.customer_id 
INNER JOIN address B ON A.address_id = B.address_id 
INNER JOIN city C ON B.city_id = C.city_id 
INNER JOIN country D ON C.country_id = D.country_id 
GROUP BY A.customer_id, D.country 
), 
avg_total AS ( 
SELECT AVG(total_sum) AS avg_sum 
FROM customer_totals 
), 
top_customers AS ( 
SELECT ct.customer_id, ct.country 
FROM customer_totals ct 
CROSS JOIN avg_total a 
WHERE ct.total_sum > a.avg_sum 
) 
SELECT  
D.country, 
COUNT(DISTINCT A.customer_id) AS all_customer_count, 
COUNT(DISTINCT T.customer_id) AS top_customer_count 
FROM customer A 
INNER JOIN address B ON A.address_id = B.address_id 
INNER JOIN city C ON B.city_id = C.city_id 
INNER JOIN country D ON C.country_id = D.country_id 
LEFT JOIN top_customers T ON A.customer_id = T.customer_id 
GROUP BY D.country 
ORDER BY top_customer_count DESC 
LIMIT 10;
